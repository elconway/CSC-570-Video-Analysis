<html>
  <head>
    <script src="webgazer.js" type="text/javascript"></script>
  </head>
    <script>
      var writeData = ["Timestamp,X,Y\n"];
      var videoLink = "";
      webgazer.resume();
      var count = 0;
      var tok = "";

      // Create WebSocket connection.
      const socket = new WebSocket("wss://localhost:6868");

      // Connection opened
      socket.addEventListener("open", (event) => {
        socket.send('{"id": 1, "jsonrpc": "2.0", "method": "requestAccess", "params": { "clientId": "0ua6IB2Pe9hhbGIJNV9CAqxAw8tuuPYDAHRGv4eW", "clientSecret": "AZohMUYKfW9YCHTjwb74l2CyAK7xs75bDzgfnmrGzDHtiwZEIckyyfC4V0gGJ3LbWP4VVNeUevXYnIq1UkmDxYJInDYBL5ibqDZnjner33SKWS7O4C5boDLD4fnJ0ZPy"}}');
        socket.send('{"id": 1, "jsonrpc": "2.0", "method": "authorize", "params": { "clientId": "0ua6IB2Pe9hhbGIJNV9CAqxAw8tuuPYDAHRGv4eW", "clientSecret": "AZohMUYKfW9YCHTjwb74l2CyAK7xs75bDzgfnmrGzDHtiwZEIckyyfC4V0gGJ3LbWP4VVNeUevXYnIq1UkmDxYJInDYBL5ibqDZnjner33SKWS7O4C5boDLD4fnJ0ZPy"}}');
      });

      // Listen for messages
      socket.addEventListener("message", (event) => {
        if (count == 1) {
          tok = JSON.parse(event.data).result.cortexToken;
          socket.send('{"id": 1, "jsonrpc": "2.0", "method": "generateNewToken", "params": { "cortexToken": "' + tok + '", "clientId": "0ua6IB2Pe9hhbGIJNV9CAqxAw8tuuPYDAHRGv4eW", "clientSecret": "AZohMUYKfW9YCHTjwb74l2CyAK7xs75bDzgfnmrGzDHtiwZEIckyyfC4V0gGJ3LbWP4VVNeUevXYnIq1UkmDxYJInDYBL5ibqDZnjner33SKWS7O4C5boDLD4fnJ0ZPy"}}');
          console.log("TOK", tok);
        } else {
          console.log("Message from server ", event.data);
        }
        count = count + 1;
      });

      webgazer.setGazeListener(function(data, elapsedTime) {
        if (data != null) {
          var x = data.x;
          var y = data.y;
          document.getElementById("gazeData").innerHTML = "Gaze coordinates: x=" + x + ", y=" + y;
          writeData.push(Date.now() + "," + x + "," + y + "\n");
        }
      }).begin();
      
      function createVideo() {
        var id = document.getElementById("vidLink").value;
        console.log(id);
        var vid = document.getElementById("videoView");
        if (id.includes("http")) {
          vid.src = id.substring(0, 24) + "embed/" + id.substring(32);
        } else {
          vid.src = "https://www.youtube.com/embed/" + id;
        }
      }
      
      function createDownload() {
        var filename = "data.csv";
        var blob = new Blob(writeData, {type:'text/plain'});
        var link = document.getElementById("link");
        link.download = filename;
        link.innerHTML = "Download File";
        link.href = window.URL.createObjectURL(blob);
      }

    </script>
  <body>
    <div style="text-align: right;" id="gazeData"></div>
    <div style="text-align: right;" id="linkInput">
      <input type="text" id="vidLink"></input>
      <button onclick="createVideo()">Submit</button>
    </div>
    <style>
          html, body {height: 100%;margin: 0; padding: 0; }
          table, iframe {width: 100%;height: 100%;border-collapse: collapse;}
          td {border: 1px solid black;border-collapse: collapse;}
          img {width: 50%;height: 70%;display: block;margin-left: auto;margin-right: auto;}
    </style>
    <table>
      <tr>
        <td id="Cell 1"><img src="images/sadness.png"></img></td>
        <td id="Cell 2"><img src="images/sad.jpg"></img></td>
        <td id="Cell 3"><img src="images/angry.png"></img></td>
      </tr>
      <tr>
        <td id="Cell 4"><img src="images/embarassed.jpg"></img></td>
        <td id="Cell 5"><img src="images/happy.png"></img></td>
        <td id="Cell 6"><img src="images/frustrated.png"></img></td>
      </tr>
      <tr>
        <td id="Cell 7"><img src="images/fear.png"></img></td>
        <td id="Cell 8"><img src="images/surprised.png"></img></td>
        <td id="Cell 9"><img src="images/disgust.png"></img></td>
      </tr>
      <tr>
        <td id="Cell 10"><img src=""></img></td>
        <td id="Cell 11"><a id="link">Download File</a></td>
        <td id="Cell 12"><button onclick="createDownload()">Create Download</button></td>
      </tr>
    </table>
    <iframe id="videoView" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
  </body>
</html>